<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Carta de Amor Animada</title>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Pacifico&display=swap');
    @import url('https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700&display=swap');
    html, body {
      margin: 0;
      padding: 0;
      width: 100vw;
      height: 100vh;
      background: #f8e1e7;
      overflow: hidden;
    }
    body {
      display: flex;
      align-items: center;
      justify-content: center;
      min-height: 100vh;
      transition: filter 0.6s cubic-bezier(.77,0,.18,1);
      position: relative;
      background: linear-gradient(135deg, #cf6581 0%, #e7a2d5 100%);
      transition: background 1.2s cubic-bezier(.77,0,.18,1), filter 0.6s cubic-bezier(.77,0,.18,1);
    }
    body::before {
      content: "";
      position: fixed;
      inset: 0;
      z-index: 0;
      background: inherit;
      transition: filter 0.6s cubic-bezier(.77,0,.18,1);
      pointer-events: none;
    }
    body.blurred::before {
      filter: blur(2.5px) brightness(0.98);
    }
    body.bg-open {
      background: linear-gradient(120deg, #0e0d0d 0%, #231c1f 60%, #1e1b1c 100%);
    }
    #cartaCanvas {
      background: radial-gradient(circle at 60% 40%, #161616 60%, #000000 100%);
      display: block;
      cursor: pointer;
      box-shadow: 0 8px 32px rgba(0,0,0,0.18);
      border-radius: 16px;
      transition: box-shadow 0.3s, transform 0.7s cubic-bezier(.77,0,.18,1), filter 0.3s;
      max-width: 95vw;
      max-height: 80vh;
      position: relative;
      z-index: 2;
    }
    #cartaCanvas:active {
      box-shadow: 0 2px 8px rgba(0,0,0,0.10);
    }
    #cartaCanvas.enlarged {
      transform: scale(1.18);
      box-shadow: 0 12px 48px 0 rgba(230,57,70,0.18), 0 0 0 8px #fffbe8;
    }
    #cartaCanvas:hover {
      filter: brightness(1.04) drop-shadow(0 0 12px #ffd70055);
      transform: scale(1.025) rotate(-1deg);
      box-shadow: 0 12px 48px 0 rgba(230,57,70,0.18), 0 0 0 8px #fffbe8;
    }
    .ui-overlay {
      position: absolute;
      top: 0; left: 0; width: 100vw; height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: flex-end;
      pointer-events: none;
      z-index: 3;
    }
    .subtitle {
      font-family: 'Montserrat', sans-serif;
      font-size: 1.2rem;
      color: #b5838d;
      margin-bottom: 2.5rem;
      letter-spacing: 1px;
      background: rgba(255,255,255,0.7);
      border-radius: 8px;
      padding: 0.5rem 1.2rem;
      box-shadow: 0 2px 8px rgba(0,0,0,0.04);
      pointer-events: auto;
      transition: opacity 0.5s;
    }
    .close-btn {
      position: absolute;
      top: 2.5rem;
      right: 3rem;
      background: #fffbe8;
      color: #e63946;
      border: none;
      border-radius: 50%;
      width: 44px;
      height: 44px;
      font-size: 1.7rem;
      font-family: 'Montserrat', sans-serif;
      box-shadow: 0 2px 8px rgba(0,0,0,0.09);
      cursor: pointer;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.5s, box-shadow 0.3s, transform 0.3s;
      z-index: 20;
      overflow: visible;
    }
    .close-btn.visible {
      opacity: 1;
      pointer-events: auto;
    }
    .close-btn .tooltip {
      visibility: hidden;
      opacity: 0;
      position: absolute;
      top: 110%;
      left: 50%;
      transform: translateX(-50%);
      background: #fffbe8;
      color: #b5838d;
      padding: 0.3em 0.8em;
      border-radius: 6px;
      font-size: 0.95rem;
      font-family: 'Montserrat', sans-serif;
      box-shadow: 0 2px 8px rgba(0,0,0,0.07);
      transition: opacity 0.3s;
      pointer-events: none;
      z-index: 100;
      white-space: nowrap;
    }
    .close-btn:hover .tooltip,
    .close-btn:focus .tooltip {
      visibility: visible;
      opacity: 1;
    }
    .close-btn:hover {
      box-shadow: 0 4px 16px rgba(230,57,70,0.13);
      transform: scale(1.13) rotate(-8deg);
      background: #fffbe8;
    }
    .close-btn:active {
      transform: scale(0.97) rotate(0deg);
    }
    @media (max-width: 600px) {
      #cartaCanvas { width: 98vw !important; height: 70vw !important; }
      .close-btn { top: 1rem; right: 1rem; }
      .subtitle { font-size: 1rem; }
    }
    .firma {
      position: absolute;
      left: 2vw;
      bottom: 1.5vh;
      font-family: 'Pacifico', cursive;
      font-size: 1.1rem;
      color: #b5838d;
      opacity: 0.7;
      pointer-events: none;
      user-select: none;
      z-index: 30;
      letter-spacing: 1px;
    }
    @media (max-width: 600px) {
      .firma { font-size: 0.9rem; left: 2vw; bottom: 1vh; }
    }
    .download-btn {
      position: absolute;
      bottom: 2.5rem;
      right: 3rem;
      background: #fffbe8;
      border: none;
      border-radius: 50%;
      width: 44px;
      height: 44px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.09);
      cursor: pointer;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.5s, box-shadow 0.3s, transform 0.3s;
      z-index: 20;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .download-btn.visible {
      opacity: 1;
      pointer-events: auto;
    }
    .download-btn svg { pointer-events: none; }
    .download-btn:hover {
      box-shadow: 0 4px 16px rgba(230,57,70,0.13);
      transform: scale(1.13) rotate(-8deg);
      background: #fffbe8;
    }
    .download-btn:active {
      transform: scale(0.97) rotate(0deg);
    }
    @media (max-width: 600px) {
      .download-btn { bottom: 1rem; right: 1rem; }
    }
    .download-msg {
      position: absolute;
      bottom: 6.5rem;
      right: 3.2rem;
      background: #fffbe8;
      color: #e63946;
      font-family: 'Montserrat', sans-serif;
      font-size: 1.1rem;
      border-radius: 8px;
      padding: 0.5em 1.2em;
      box-shadow: 0 2px 8px rgba(0,0,0,0.07);
      opacity: 0;
      pointer-events: none;
      z-index: 30;
      transition: opacity 0.4s;
    }
    @media (max-width: 600px) {
      .download-msg { bottom: 4.5rem; right: 1.2rem; font-size: 1rem; }
    }
  </style>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.5/gsap.min.js"></script>
</head>
<body>
  <canvas id="cartaCanvas" width="500" height="400"></canvas>
  <div class="ui-overlay">
    <div class="subtitle" id="subtitle">Haz click en la carta para abrirla</div>
    <button class="close-btn" id="closeBtn" title="Cerrar carta" aria-label="Cerrar carta">
      &times;
      <span class="tooltip" id="closeTooltip">Cerrar</span>
    </button>
    <button class="download-btn" id="downloadBtn" title="Descargar carta" aria-label="Descargar carta">
      <svg width="22" height="22" viewBox="0 0 22 22"><path fill="#b5838d" d="M11 2v12.59l4.3-4.3 1.42 1.42L11 18.41l-5.71-5.7 1.41-1.42L11 14.59V2h2z"/><rect fill="none" width="22" height="22"/></svg>
    </button>
    <div id="downloadMsg" class="download-msg">¡Descargado!</div>
  </div>
  <div class="firma">Con cariño, Zero</div>
  <audio id="openSound" src="https://cdn.pixabay.com/audio/2022/07/26/audio_124bfae6b5.mp3" preload="auto"></audio>
  <audio id="closeSound" src="https://cdn.pixabay.com/audio/2022/07/26/audio_124bfae6b5.mp3" preload="auto"></audio>
  <script>
    const canvas = document.getElementById('cartaCanvas');
    const ctx = canvas.getContext('2d');

    // Carta config
    const carta = {
      x: 100, y: 100, w: 300, h: 180,
      flapHeight: 60,
      openProgress: 0, // 0 cerrado, 1 abierto
      opening: false,
      bounce: 0 // rebote de la tapa
    };

    // Corazones animados
    const corazones = [];
    function crearCorazon() {
      // Colores variados
      const colores = ["#e63946", "#ffb4d9", "#ff6f91", "#ffb3c6"];
      const color = colores[Math.floor(Math.random()*colores.length)];
      // Corazones más esparcidos por toda la pantalla
      const x = Math.random() * canvas.width * 0.95 + canvas.width * 0.025;
      const y = carta.y + carta.flapHeight + 20 + Math.random() * (canvas.height - (carta.y + carta.flapHeight + 60));
      const size = 18 + Math.random()*16;
      const speed = 1.1 + Math.random()*1.5;
      const dx = (Math.random()-0.5)*1.8;
      const curve = (Math.random()-0.5)*0.012;
      corazones.push({
        x,
        y,
        size,
        speed,
        dx,
        alpha: 1,
        rot: (Math.random()-0.5)*0.7,
        color,
        curve,
        t: 0
      });
    }

    function dibujarCorazon(x, y, size, alpha=1, rot=0, color="#e63946") {
      ctx.save();
      ctx.translate(x, y);
      ctx.rotate(rot);
      ctx.globalAlpha = alpha;
      ctx.beginPath();
      ctx.moveTo(0, 0);
      ctx.bezierCurveTo(-size/2, -size/2, -size, size/3, 0, size);
      ctx.bezierCurveTo(size, size/3, size/2, -size/2, 0, 0);
      ctx.fillStyle = color;
      ctx.shadowColor = color;
      ctx.shadowBlur = 10;
      ctx.fill();
      ctx.globalAlpha = 1;
      ctx.shadowBlur = 0;
      ctx.restore();
    }

    // Partículas de brillo
    const brillos = [];
    function crearBrillo() {
      for (let i=0; i<8; i++) {
        brillos.push({
          x: carta.x + carta.w/2 + (Math.random()-0.5)*carta.w*0.7,
          y: carta.y + carta.h/2 + (Math.random()-0.5)*carta.h*0.7,
          r: 1 + Math.random()*2.5,
          alpha: 0.7 + Math.random()*0.3,
          vy: -0.5 - Math.random()*1.2,
          life: 40 + Math.random()*30
        });
      }
    }
    function dibujarBrillos() {
      for (let i=brillos.length-1; i>=0; i--) {
        const b = brillos[i];
        ctx.save();
        ctx.globalAlpha = b.alpha;
        ctx.beginPath();
        ctx.arc(b.x, b.y, b.r, 0, 2*Math.PI);
        ctx.fillStyle = "#fffbe8";
        ctx.shadowColor = "#fffbe8";
        ctx.shadowBlur = 12;
        ctx.fill();
        ctx.restore();
        b.y += b.vy;
        b.alpha -= 0.012;
        b.life--;
        if (b.life <= 0 || b.alpha <= 0) brillos.splice(i,1);
      }
    }

    // Mensaje
    let mensaje = "¡Te quiero mucho , gracias por ser como eres #03 💌";
    let mostrarMensaje = false;
    let mensajeAnim = {
      texto: "",
      idx: 0,
      timer: null,
      velocidad: 28 // ms por letra
    };

    function iniciarAnimMensaje() {
      mensajeAnim.texto = "";
      mensajeAnim.idx = 0;
      if (mensajeAnim.timer) clearInterval(mensajeAnim.timer);
      mensajeAnim.timer = setInterval(() => {
        if (mensajeAnim.idx < mensaje.length) {
          mensajeAnim.texto += mensaje[mensajeAnim.idx];
          mensajeAnim.idx++;
        } else {
          clearInterval(mensajeAnim.timer);
        }
      }, mensajeAnim.velocidad);
    }

    // --- Destello animado en el borde dorado ---
    let destello = {
      t: 0,
      active: false
    };

    function dibujarCarta() {
      // Sombra y brillo al abrir
      ctx.save();
      ctx.shadowColor = "#b5838d";
      ctx.shadowBlur = 18 * (1-carta.openProgress);
      ctx.fillStyle = "#fff";
      ctx.fillRect(carta.x+8, carta.y+8, carta.w, carta.h);
      if (carta.openProgress > 0.95) {
        // Efecto de brillo
        ctx.globalAlpha = (carta.openProgress-0.95)/0.05 * 0.5;
        ctx.fillStyle = "#fffbe8";
        ctx.beginPath();
        ctx.ellipse(carta.x + carta.w/2, carta.y + carta.h/2, carta.w/2, carta.h/3, 0, 0, 2*Math.PI);
        ctx.fill();
        ctx.globalAlpha = 1;
      }
      ctx.restore();

      // Cuerpo de la carta con borde dorado
      ctx.save();
      ctx.fillStyle = "#fff";
      ctx.strokeStyle = "#ffd700";
      ctx.lineWidth = 4;
      ctx.beginPath();
      ctx.rect(carta.x, carta.y, carta.w, carta.h);
      ctx.fill();
      ctx.stroke();
      ctx.restore();

      // --- Detalles "Para:" y "De:" en el sobre ---
      if (carta.openProgress < 0.2) {
        ctx.save();
        ctx.font = "bold 1.05rem 'Montserrat', sans-serif";
        ctx.fillStyle = "#b5838d";
        ctx.globalAlpha = 0.85;
        // "Para:"
        ctx.textAlign = "left";
        ctx.fillText("Para:", carta.x + 18, carta.y + 32);
        ctx.font = "normal 1rem 'Pacifico', cursive";
        ctx.fillText("Mi amor", carta.x + 60, carta.y + 32);
        // "De:"
        ctx.font = "bold 1.05rem 'Montserrat', sans-serif";
        ctx.textAlign = "right";
        ctx.fillText("De:", carta.x + carta.w -300, carta.y + carta.h - 18);
        ctx.font = "normal 1rem 'Pacifico', cursive";
        ctx.fillText("Zero", carta.x + carta.w - 60, carta.y + carta.h - 18);
        ctx.restore();
      }

      // --- Destello animado en el borde dorado ---
      ctx.save();
      ctx.strokeStyle = "#ffd700";
      ctx.lineWidth = 4;
      ctx.beginPath();
      ctx.rect(carta.x, carta.y, carta.w, carta.h);
      ctx.stroke();

      // Destello
      if (destello.active) {
        const t = destello.t;
        const len = 2*(carta.w + carta.h);
        const pos = (t % 1) * len;
        ctx.save();
        ctx.strokeStyle = ctx.createLinearGradient(
          carta.x, carta.y, carta.x + carta.w, carta.y + carta.h
        );
        ctx.shadowColor = "#fffbe8";
        ctx.shadowBlur = 18;
        ctx.lineWidth = 8;
        ctx.globalAlpha = 0.7;
        ctx.beginPath();
        // Recorrer el borde y dibujar un segmento brillante
        let p = pos;
        for (let i = 0; i < 1; i += 0.25) {
          let seg = Math.min(40, len - p);
          if (p < carta.w) {
            ctx.moveTo(carta.x + p, carta.y);
            ctx.lineTo(carta.x + Math.min(carta.w, p + seg), carta.y);
          } else if (p < carta.w + carta.h) {
            ctx.moveTo(carta.x + carta.w, carta.y + (p - carta.w));
            ctx.lineTo(carta.x + carta.w, carta.y + Math.min(carta.h, p - carta.w + seg));
          } else if (p < 2 * carta.w + carta.h) {
            ctx.moveTo(carta.x + carta.w - (p - carta.w - carta.h), carta.y + carta.h);
            ctx.lineTo(carta.x + carta.w - Math.min(carta.w, p - carta.w - carta.h + seg), carta.y + carta.h);
          } else {
            ctx.moveTo(carta.x, carta.y + carta.h - (p - 2 * carta.w - carta.h));
            ctx.lineTo(carta.x, carta.y + carta.h - Math.min(carta.h, p - 2 * carta.w - carta.h + seg));
          }
          p += 60;
        }
        ctx.stroke();
        ctx.restore();
      }
      ctx.restore();

      // Líneas decorativas
      ctx.save();
      ctx.strokeStyle = "#f9c6d1";
      ctx.lineWidth = 2;
      ctx.beginPath();
      ctx.moveTo(carta.x+20, carta.y+carta.h-20);
      ctx.lineTo(carta.x+carta.w-20, carta.y+carta.h-20);
      ctx.stroke();
      ctx.restore();

      // Sello de corazón
      ctx.save();
      ctx.globalAlpha = 0.7;
      dibujarCorazon(carta.x + carta.w - 36, carta.y + carta.h - 36, 22, 1, 0, "#e63946");
      ctx.restore();

      // Flap (tapa) animada con rebote
      ctx.save();
      ctx.translate(carta.x + carta.w/2, carta.y);
      let flapAngle = -Math.PI/2 * carta.openProgress + carta.bounce;
      ctx.rotate(flapAngle);
      ctx.beginPath();
      ctx.moveTo(-carta.w/2, 0);
      ctx.lineTo(0, -carta.flapHeight);
      ctx.lineTo(carta.w/2, 0);
      ctx.closePath();
      ctx.fillStyle = "#f9c6d1";
      ctx.strokeStyle = "#b5838d";
      ctx.fill();
      ctx.stroke();
      ctx.restore();

      // Papel interior animado y adaptativo
      if (carta.openProgress > 0.7) {
        ctx.save();
        let slide = Math.min(1, (carta.openProgress-0.7)/0.3);
        ctx.globalAlpha = slide;
        ctx.fillStyle = "#fffbe8";
        ctx.strokeStyle = "#b5838d";
        ctx.lineWidth = 1.5;

        // Calcular alto del papel según el mensaje
        const paperX = carta.x+18;
        const paperW = carta.w-36;
        const minPaperH = carta.h-60;
        const maxPaperH = carta.h*1.2;
        ctx.font = "bold 30px 'Pacifico', cursive";
        const lineHeight = 36;
        const words = mensaje.split(' ');
        let lines = [];
        let currentLine = "";
        for (let i = 0; i < words.length; i++) {
          let testLine = currentLine + (currentLine ? " " : "") + words[i];
          let testWidth = ctx.measureText(testLine).width;
          if (testWidth > paperW-24 && currentLine) {
            lines.push(currentLine);
            currentLine = words[i];
          } else {
            currentLine = testLine;
          }
        }
        if (currentLine) lines.push(currentLine);
        let paperH = Math.max(minPaperH, Math.min(maxPaperH, lines.length * lineHeight + 40));
        let paperY = carta.y+30 + (1-slide)*40 - (paperH-minPaperH)/2;

        ctx.beginPath();
        ctx.rect(paperX, paperY, paperW, paperH);
        ctx.fill();
        ctx.stroke();
        ctx.restore();

        // Mensaje estilizado y envuelto
        if (mostrarMensaje) {
          ctx.save();
          ctx.font = "bold 30px 'Pacifico', cursive";
          ctx.fillStyle = "#b5838d";
          ctx.textAlign = "center";
          ctx.globalAlpha = Math.min(1, (carta.openProgress-0.85)/0.15);
          ctx.shadowColor = "#fffbe8";
          ctx.shadowBlur = 8;
          // --- Animación de escritura ---
          let textoMostrar = mensajeAnim.texto || "";
          // Recalcular líneas para el texto parcial
          let partialWords = textoMostrar.split(' ');
          let linesAnim = [];
          let currentLineAnim = "";
          for (let i = 0; i < partialWords.length; i++) {
            let testLine = currentLineAnim + (currentLineAnim ? " " : "") + partialWords[i];
            let testWidth = ctx.measureText(testLine).width;
            if (testWidth > paperW-24 && currentLineAnim) {
              linesAnim.push(currentLineAnim);
              currentLineAnim = partialWords[i];
            } else {
              currentLineAnim = testLine;
            }
          }
          if (currentLineAnim) linesAnim.push(currentLineAnim);
          for (let i = 0; i < linesAnim.length; i++) {
            ctx.fillText(
              linesAnim[i],
              carta.x + carta.w/2,
              paperY + paperH/2 - (linesAnim.length-1)*lineHeight/2 + i*lineHeight + 8
            );
          }
          ctx.shadowBlur = 0;
          ctx.restore();
        }
      }

      dibujarConfeti();
    }

    function animar() {
      ctx.clearRect(0, 0, canvas.width, canvas.height);

      dibujarCarta();
      dibujarBrillos();

      // Corazones animados
      if (carta.openProgress > 0.7) {
        if (Math.random() < 0.05) crearCorazon();
        for (let i = corazones.length-1; i >= 0; i--) {
          const c = corazones[i];
          c.t += 1;
          c.y -= c.speed;
          c.x += c.dx + Math.sin(c.t*0.04)*c.curve*80;
          c.alpha -= 0.0009;
          dibujarCorazon(c.x, c.y, c.size, c.alpha, c.rot, c.color);
          if (c.alpha <= 0) corazones.splice(i, 1);
        }
      }

      // --- Destello animado en el borde dorado ---
      if (destello.active) {
        destello.t += 0.018;
        if (destello.t > 1.2) destello.active = false;
      }

      requestAnimationFrame(animar);
    }

    // Confeti animado
    const confetis = [];
    function lanzarConfeti() {
      const colores = ["#e63946", "#ffb4d9", "#ff6f91", "#ffb3c6", "#ffd700", "#b5838d", "#fffbe8"];
      for (let i = 0; i < 32; i++) {
        confetis.push({
          x: carta.x + carta.w/2,
          y: carta.y + carta.h/2,
          r: 6 + Math.random()*6,
          color: colores[Math.floor(Math.random()*colores.length)],
          vx: (Math.random()-0.5)*7,
          vy: -4 - Math.random()*5,
          ay: 0.18 + Math.random()*0.08,
          rot: Math.random()*Math.PI*2,
          vr: (Math.random()-0.5)*0.2,
          alpha: 1
        });
      }
    }
    function dibujarConfeti() {
      for (let i = confetis.length-1; i >= 0; i--) {
        const c = confetis[i];
        ctx.save();
        ctx.globalAlpha = c.alpha;
        ctx.translate(c.x, c.y);
        ctx.rotate(c.rot);
        ctx.fillStyle = c.color;
        ctx.beginPath();
        ctx.ellipse(0, 0, c.r, c.r*0.5, 0, 0, 2*Math.PI);
        ctx.fill();
        ctx.restore();
        c.x += c.vx;
        c.y += c.vy;
        c.vy += c.ay;
        c.rot += c.vr;
        c.alpha -= 0.008;
        if (c.alpha <= 0 || c.y > canvas.height+40) confetis.splice(i, 1);
      }
    }

    // Agrandar carta y blur fondo al abrir
    function abrirCarta() {
      if (carta.opening) return;
      carta.opening = true;
      document.getElementById('subtitle').style.opacity = 0;
      document.getElementById('openSound').currentTime = 0;
      document.getElementById('openSound').play();
      document.body.classList.add('blurred');
      document.body.classList.add('bg-open');
      canvas.classList.add('enlarged');
      lanzarConfeti();
      destello.active = true;
      destello.t = 0;
      gsap.to(carta, {
        openProgress: 1,
        duration: 1.1,
        ease: "elastic.out(1, 0.7)",
        onUpdate: () => {
          if (carta.openProgress > 0.7 && brillos.length < 8) crearBrillo();
        },
        onComplete: () => {
          mostrarMensaje = true;
          iniciarAnimMensaje();
          document.getElementById('closeBtn').classList.add('visible');
          document.getElementById('downloadBtn').classList.add('visible');
        }
      });
    }

    // Restaurar tamaño y fondo al cerrar
    function cerrarCarta() {
      if (!carta.opening) return;
      document.getElementById('closeBtn').classList.remove('visible');
      document.getElementById('downloadBtn').classList.remove('visible');
      document.body.classList.remove('blurred');
      document.body.classList.remove('bg-open');
      canvas.classList.remove('enlarged');
      mostrarMensaje = false;
      if (mensajeAnim.timer) clearInterval(mensajeAnim.timer);
      // --- Sonido suave al cerrar ---
      const closeSound = document.getElementById('closeSound');
      closeSound.currentTime = 0.18;
      closeSound.volume = 0.23;
      closeSound.play();
      gsap.to(carta, {
        openProgress: 0,
        duration: 0.7,
        ease: "power2.inOut",
        onUpdate: () => {},
        onComplete: () => {
          carta.opening = false;
          document.getElementById('subtitle').style.opacity = 1;
        }
      });
    }

    // Descargar carta como imagen con feedback visual
    document.getElementById('downloadBtn').addEventListener('click', () => {
      setTimeout(() => {
        const link = document.createElement('a');
        link.download = 'carta.png';
        link.href = canvas.toDataURL('image/png');
        link.click();
        // Mostrar mensaje de descargado
        const msg = document.getElementById('downloadMsg');
        msg.style.opacity = 1;
        setTimeout(() => { msg.style.opacity = 0; }, 1300);
      }, 200);
    });

    // Responsive canvas
    function resizeCanvas() {
      const ratio = 5/4;
      let w = Math.min(window.innerWidth * 0.95, 600);
      let h = w / ratio;
      if (h > window.innerHeight * 0.8) {
        h = window.innerHeight * 0.8;
        w = h * ratio;
      }
      canvas.width = w;
      canvas.height = h;
      carta.x = w*0.2;
      carta.y = h*0.25;
      carta.w = w*0.6;
      carta.h = h*0.45;
      carta.flapHeight = carta.h*0.33;
    }
    window.addEventListener('resize', resizeCanvas);
    resizeCanvas();

    canvas.addEventListener('click', abrirCarta);
    document.getElementById('closeBtn').addEventListener('click', cerrarCarta);

    animar();

    // Animación de entrada de la carta
    gsap.fromTo(
      "#cartaCanvas",
      { y: -120, opacity: 0 },
      { y: 0, opacity: 1, duration: 1.2, ease: "bounce.out", delay: 0.2 }
    );

    // Tooltip en botón cerrar (ya está en CSS, solo para touch)
    const closeBtn = document.getElementById('closeBtn');
    const closeTooltip = document.getElementById('closeTooltip');
    closeBtn.addEventListener('touchstart', () => {
      closeTooltip.style.visibility = 'visible';
      closeTooltip.style.opacity = '1';
    });
    closeBtn.addEventListener('touchend', () => {
      setTimeout(() => {
        closeTooltip.style.visibility = '';
        closeTooltip.style.opacity = '';
      }, 800);
    });

    // Accesibilidad: abrir/cerrar con teclado
    document.addEventListener('keydown', (e) => {
      if (e.code === 'Space' || e.code === 'Enter') {
        if (!carta.opening) abrirCarta();
        else if (mostrarMensaje) cerrarCarta();
      }
      if (e.code === 'Escape' && carta.opening && mostrarMensaje) cerrarCarta();
    });

    // Instrucción móvil
    function isMobile() {
      return /Android|iPhone|iPad|iPod|Opera Mini|IEMobile|WPDesktop/i.test(navigator.userAgent);
    }
    window.addEventListener('DOMContentLoaded', () => {
      if (isMobile()) {
        document.getElementById('subtitle').textContent = "Toca la carta para abrirla";
      }
    });
  </script>
</body>
</html>